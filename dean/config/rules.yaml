# =====================================================
# DEAN BUSINESS RULES
# Performance Thresholds, Kill/Promotion Rules
# =====================================================

version: 2.0
env: prod

# ── Performance Thresholds ───────────────────────────
thresholds:
  ctr:
    testing_floor: 0.006      # Minimum CTR to continue testing
    validation_floor: 0.008    # Minimum CTR in validation
  
  cpa:  # EUR
    testing_max: 45            # Max CPA before kill in testing
    validation_max: 55         # Max CPA before kill in validation
    scaling_kill_max: 50       # Max CPA before kill in scaling
  
  roas:
    testing_min: 1.2           # Min ROAS to promote from testing
    validation_min: 1.5        # Min ROAS to promote from validation
    scaling_kill_min: 1.0      # Min ROAS to keep in scaling

# ── Minimum Requirements ──────────────────────────────
minimums:
  impressions: 200
  clicks: 0
  spend_eur: 8

# ── Testing Stage Rules ───────────────────────────────
testing:
  minimums:
    min_impressions: 200
    min_spend_eur: 8
  
  # 7-TIER LEARNING ACCELERATION SYSTEM
  # Prioritizes high-performing ads with extended learning budgets
  kill:
    # Tier 0: ZERO PERFORMANCE - Quick kill to save budget
    - {type: "zero_performance_quick_kill", spend_gte: 30, ctr_lt: 0.001}
    
    # Tier 1: MASSIVE learning budget for multi-ATC ads
    - {type: "learning_acceleration_multi_atc", spend_gte: 500, atc_gte: 3}
    - {type: "learning_acceleration_multi_atc", spend_gte: 400, atc_gte: 2}
    - {type: "learning_acceleration_multi_atc", spend_gte: 300, atc_gte: 1}
    
    # Tier 2: EXCELLENT performance (CTR > 2%, ATC > 0)
    - {type: "spend_no_purchase_with_conditions", spend_gte: 250, ctr_gte: 0.02, atc_gte: 1}
    
    # Tier 3: HIGH CTR learning (CTR > 2% without ATC)
    - {type: "learning_acceleration_high_ctr", spend_gte: 200, ctr_gte: 0.02}
    
    # Tier 4: GOOD performance (CTR > 1%, ATC > 0)
    - {type: "spend_no_purchase_with_conditions", spend_gte: 150, ctr_gte: 0.01, atc_gte: 1}
    
    # Tier 5: DECENT CTR (CTR > 1.5% without ATC)
    - {type: "learning_acceleration_high_ctr", spend_gte: 120, ctr_gte: 0.015}
    
    # Tier 6: AVERAGE performance (CTR > 0.5%)
    - {type: "spend_no_purchase_with_conditions", spend_gte: 100, ctr_gte: 0.005}
    
    # Tier 7: POOR performance - Kill sooner
    - {type: "spend_no_purchase_with_conditions", spend_gte: 60, ctr_lt: 0.005, atc_lt: 1}
    
    # ATC REWARD RULES
    - {type: "atc_gte", atc_gte: 1, spend_gte: 40, budget_boost: 50}
    - {type: "atc_gte", atc_gte: 2, spend_gte: 60, promote: true}
    - {type: "atc_learning_acceleration", atc_gte: 1, spend_gte: 80, budget_boost: 100}
    
    # Standard engagement rules
    - {type: "cpa_gte", cpa_gte: 45}
    - {type: "ctr_below", ctr_lt: 0.006, spend_gte: 30}
    - {type: "spend_no_purchase", spend_gte: 45}
    - {type: "spend_multi_atc_no_purchase", spend_gte: 60, atc_gte: 2}
    - {type: "roas_below_after_days", roas_lt: 1.2, window: "day_3"}
  
  # Promotion rules
  advance:
    operator: "any"
    rules:
      - {type: "purchase_gte", purchases_gte: 1}
      - {type: "atc_gte", atc_gte: 3}  # Fast-track high ATC
  
  # Engine configuration
  engine:
    consecutive_ticks_required: 2
    
    fairness:
      min_spend_before_kill_eur: 20
      min_runtime_hours: 12
    
    learning:
      max_learning_budget_eur: 500
    
    tripwires:
      lifetime_spend_no_purchase_eur: 45
    
    bayes:
      prior_a: 2.0
      prior_b: 300.0
      sample_count: 32
      kill_prob: 0.90
    
    adaptive_ctr:
      floor_min: 0.008
      floor_scale: 0.70
      min_impressions: 300
    
    fatigue:
      ewma_alpha: 0.30
      drop_pct: 0.35
    
    promotion:
      pause_after_promotion: true
      validation_budget_eur: 40
      placements: ["facebook", "instagram"]
    
    queue:
      max_launches_per_tick: 8
    
    attribution_windows: ["7d_click", "1d_view"]

# ── Validation Stage Rules ────────────────────────────
validation:
  minimums:
    min_impressions: 400
    min_clicks: 20
    min_spend_eur: 30
  
  # 7-TIER VALIDATION SYSTEM (mirrors testing with higher stakes)
  kill:
    # Tier 0: ZERO PERFORMANCE - Quick kill
    - {type: "zero_performance_quick_kill", spend_gte: 50, ctr_lt: 0.001}
    
    # Tier 1: Strong ATC signals
    - {type: "spend_no_purchase_with_conditions", spend_gte: 500, atc_gte: 3}
    - {type: "spend_no_purchase_with_conditions", spend_gte: 400, atc_gte: 2}
    
    # Tier 2: Excellent performance
    - {type: "spend_no_purchase_with_conditions", spend_gte: 300, ctr_gte: 0.02, atc_gte: 1}
    
    # Tier 3: High CTR learning
    - {type: "learning_acceleration_high_ctr", spend_gte: 240, ctr_gte: 0.02}
    
    # Tier 4: Good performance
    - {type: "spend_no_purchase_with_conditions", spend_gte: 200, ctr_gte: 0.01, atc_gte: 1}
    
    # Tier 5: Decent CTR
    - {type: "learning_acceleration_high_ctr", spend_gte: 160, ctr_gte: 0.015}
    
    # Tier 6: Average performance
    - {type: "spend_no_purchase_with_conditions", spend_gte: 120, ctr_gte: 0.005}
    
    # Tier 7: Poor performance
    - {type: "spend_no_purchase_with_conditions", spend_gte: 90, ctr_lt: 0.005, atc_lt: 1}
    
    # Standard rules
    - {type: "spend_no_purchase", spend_gte: 60}
    - {type: "cpa_gte", cpa_gte: 55}
    - {type: "ctr_below", ctr_lt: 0.005, spend_gte: 50}
    - {type: "spend_multi_atc_no_purchase", spend_gte: 90, atc_gte: 2}
    - {type: "roas_below_after_days", roas_lt: 1.1, window: "day_3"}
    - {type: "spend_over_2x_price_no_purchase"}
  
  # Promotion to scaling
  advance:
    operator: "all"
    rules:
      - {type: "purchase_gte", purchases_gte: 2}
      - {type: "cpa_lte", cpa_lte: 60}
      - {type: "roas_gte", roas_gte: 1.2}
      - {type: "ctr_gte", ctr_gte: 0.005}
  
  # Engine configuration
  engine:
    consecutive_ticks_required: 2
    fairness:
      min_spend_before_kill_eur: 50
    tripwires:
      lifetime_spend_no_purchase_eur: 60
    promotion:
      pause_after_promotion: true
      cooldown_hours: 24
      allow_create_on_promo_check: false
    soft_pass:
      max_budget_eur: 50
      max_cpa_eur: 60
      min_roas: 1.2
      min_ctr: 0.005
      cooldown_hours: 24
    
    attribution_windows: ["7d_click", "1d_view"]
    min_days_with_purchase: 2

# ── Scaling Stage Rules ───────────────────────────────
scaling:
  # Minimum requirements before evaluation
  minimums:
    min_spend_eur: 50
    min_impressions: 1000
    min_clicks: 10
  
  # Kill rules (stricter at scale)
  kill:
    # Zero performance safeguard
    - {type: "zero_performance_quick_kill", spend_gte: 80, ctr_lt: 0.001}
    
    # Poor engagement at scale
    - {type: "spend_no_purchase_with_conditions", spend_gte: 200, ctr_lt: 0.005, atc_lt: 1}
    
    # Core scaling kill rules
    - {type: "cpa_gte_consecutive_days", cpa_gte: 40, days: 2}
    - {type: "roas_below_consecutive_days", roas_lt: 1.2, days: 3}
    - {type: "spend_no_purchase", spend_gte: 150}
  
  # Scale up conditions
  scale_up:
    - {type: "roas_gte", roas_gte: 2.0, days: 2}
    - {type: "cpa_lte", cpa_lte: 25, days: 2}
    - {type: "stable_performance", days: 3}
  
  # Scale down conditions
  scale_down:
    - {type: "roas_declining", decline_pct: 20, days: 2}
    - {type: "cpa_increasing", increase_pct: 30, days: 2}
  
  # Creative refresh
  refresh_winner:
    enabled: true
    after_good_days: 7
    cpa_max_eur: 22
    roas_min: 3.0
  
  # Engine configuration
  engine:
    consecutive_ticks_required: 2
    kill:
      cpa_threshold_eur: 40
      cpa_days: 2
      roas_min: 1.2
      roas_days: 3
    tripwires:
      lifetime_spend_no_purchase_eur: 150
    budget:
      scale_up_pct: 50
      scale_down_pct: 25
      max_increase_per_day_pct: 100
    duplication:
      enabled: true
      min_roas: 2.5
      min_days_stable: 3
    attribution_windows: ["7d_click", "1d_view"]

# ── Global Settings ───────────────────────────────────
stability:
  consecutive_ticks: 2
  smoothing_epsilon: 0.0

attribution:
  click_days: 7
  view_days: 1
  roas_source: "computed"

windows:
  day_1: {days: 1}
  day_3: {days: 3}
  day_7: {days: 7}
  last_48h: {hours: 48}

# ── Economics ─────────────────────────────────────────
economics:
  currency: "EUR"
  breakeven_cpa_env: "BREAKEVEN_CPA"
  cogs_env: "COGS_PER_PURCHASE"
  fx:
    enabled: false
    usd_to_eur_env: "USD_EUR_RATE"
