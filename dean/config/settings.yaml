# =====================================================
# DEAN SYSTEM SETTINGS
# Infrastructure, IDs, and System Configuration
# =====================================================

version: 2.0
env: prod
branding_name: "Dean"

# ── Meta Account Configuration ───────────────────────
account:
  timezone: "Europe/Amsterdam"
  currency: "EUR"

# Copy bank configuration
copy_bank:
  path: "data/copy_bank.json"
  strategy: "round_robin"

# Campaign & AdSet IDs (root level for backward compatibility)
# Single ASC+ Campaign Setup
ids:
  asc_plus_campaign_id: "120233669753230160"  # ASC+ Campaign ID
  asc_plus_adset_id: "120233669753240160"    # ASC+ Ad Set ID
  # Legacy IDs removed - system now uses only ASC+ campaign

# ── Meta API Defaults ────────────────────────────────
meta:
  objective: "SALES"
  conversion_location: "website"
  pixel_event: "Purchase"
  bid_strategy: "lowest_cost"  # No manual bid caps
  campaign_type: "SHOPPING"  # Advantage+ Shopping Campaign (ASC)
  
  attribution:
    click_days: 7
    view_days: 1
    roas_source: "computed"
  
  geo:
    country: "US"
  
  audience:
    type: "broad"
    gender: "male"
    age_min: 18
    age_max: 54
    # No interests, no exclusions
  
  creative:
    dynamic_creative: false
    cta: "SHOP_NOW"
    link_url_env: "STORE_URL"
    instagram_actor_id_env: "IG_ACTOR_ID"
    creative_type: "static_image"  # Static images instead of UGC videos

# ── Placements ───────────────────────────────────────
placements:
  default:
    publisher_platforms: ["facebook", "instagram"]
    device_platforms: ["mobile", "desktop"]
    facebook_positions: ["feed", "video_feeds", "marketplace"]
    instagram_positions: ["feed", "story", "reels", "explore"]
    messenger_positions: []
    audience_network_positions: []
  
  # ASC+ Campaign uses Advantage+ Placements only
  asc_plus:
    advantage_plus_placements: true  # Use Advantage+ Placements
    publisher_platforms: ["facebook", "instagram"]

# ── ASC+ Campaign Configuration ──────────────────────
asc_plus:
  daily_budget_eur: 50                     # Base budget: €50/day (€5 per creative for 10 creatives)
  keep_ads_live: 10
  max_active_ads: 10
  target_active_ads: 10                    # Always maintain 10 creatives live (Andromeda requirement)
  optimization_goal: "PURCHASE"
  naming_prefix: "[ASC+]"
  
  # Budget allocation for 10 creatives (base: €50, scales up when ready)
  budget_per_creative_eur: 5.0             # €5 per creative (€50 ÷ 10) - base budget
  min_budget_per_creative_eur: 5.0        # Minimum budget per creative
  max_budget_per_creative_eur: 15.0        # Maximum budget per creative (scales up to €150/day when ready)
  
  # Scaling configuration
  scaling:
    enabled: true
    min_confidence: 0.75                   # Only scale if ML confidence > 75%
    min_roas_for_scale: 1.5                 # Minimum ROAS to consider scaling
    min_purchases_for_scale: 5              # Minimum purchases before scaling
    scale_up_threshold_pct: 20              # Only scale up if recommendation is >20% increase
  
  queue:
    enable_rotation: true
    refill_on_kill: true
    max_launches_per_day: 10                # Always keep 10 creatives running
    maintain_creative_count: 10             # Always maintain 10 creatives (Andromeda requirement)
    # Creative selection is now random - no diversity checking needed
  
  # Product information for creative generation
  product:
    name: "Brava Product"
    description: "Luxury product for men"
    features:
      - "Premium quality"
      - "Luxury design"
      - "Sophisticated"
    brand_tone: "calm confidence"
    target_audience: "Men aged 18-54"

# Scheduler cadence aligns with Andromeda requirement (10 creatives, 30-minute checks)
scheduler:
  asc_plus_tick_minutes: 30                 # Primary automation tick cadence (GitHub Actions matched)
  summary_minutes: 180                      # Summary digest cadence (3 hours)
  daily_digest_time_local: "08:00"          # Daily digest dispatch time (local timezone)
  run_order:
    - "asc_plus"                            # Ensure ASC+ stage executes first each tick

# ── Queue Management (Legacy - Not used by ASC+ which generates creatives dynamically) ──
queue:
  source: "supabase"  # or "csv"
  table: "meta_creatives"
  
  schema:
    required_columns: []  # ASC+ generates creatives dynamically, no queue needed
    optional_columns: ["creative_id", "name", "image_url", "image_hash", "primary_text", "headline", "description"]
  
  validation:
    check_media_exists: false  # Images are generated on-the-fly
    min_duration_sec: null     # Not applicable for static images
    max_duration_sec: null    # Not applicable for static images
  
  dedupe_by: ["creative_id", "name"]
  prioritization: "fifo"

# ── Notifications ─────────────────────────────────────
notifications:
  slack:
    enabled: true
    default_webhook_env: "SLACK_WEBHOOK_URL"
    errors_webhook_env: "SLACK_WEBHOOK_URL_ERRORS"
    
    routing:
      info: "default"
      warn: "default"
      error: "errors"
    
    digest:
      enabled: true
      time_local: "08:30"
      timezone: "Europe/Amsterdam"

# ── Data & Logging ────────────────────────────────────
logging:
  # SQLite for local state (required for fast operations)
  sqlite:
    enabled: true
    path: "data/state.sqlite"  # Relative to project root (dean/)
  
  # Supabase for ML data (required for ML mode)
  supabase:
    enabled: true
    table_env: "SUPABASE_TABLE"
  
  # Action logs
  actions_log: "data/actions.log.jsonl"
  
  # Daily digests
  digests_dir: "data/digests"

# ── Safety & Compliance ───────────────────────────────
safety:
  guardrails:
    account_cpa_pause_factor: 1.5
    account_cpa_window_days: 2
    no_purchases_tripwire_hours: 48
    global_daily_cap_eur: 3000
  
  spend_velocity:
    warn_24h_growth: 1.5
    warn_48h_growth: 2.5
    freeze_scaling_if_exceeds: true
  
  emergency_stop:
    enabled: true
    api_error_threshold_pct: 40
    tracking_flatline_hours: 24

# ── Compliance ────────────────────────────────────────
compliance:
  naming:
    enforce: true
    auto_prefix_if_missing: true
  
  creative:
    max_primary_text: 300
    max_headline: 60
    max_description: 150
    forbid_terms: ["cures", "miracle", "guaranteed"]
    auto_truncate: true

# ── Execution ─────────────────────────────────────────
execution:
  rate_limits:
    retry_max: 5
    backoff_base_seconds: 0.6
    respect_retry_after: true
  
  pagination:
    insights_page_limit: 500
    max_pages: 50
  
  concurrency:
    writes_max_parallel: 3
    reads_max_parallel: 5

# ── Data Quality ──────────────────────────────────────
data_quality:
  missing_actions_alert:
    enabled: true
    min_spend_for_alert_eur: 20
  
  tracking_drop_alert:
    enabled: true
    drop_pct_vs_7d_avg: 60

# ── Creative Intelligence System ──────────────────────
creative_intelligence:
  # System settings
  enabled: true
  auto_load_copy_bank: true
  update_performance_scores: true
  
  # Performance tracking
  performance_tracking:
    enabled: true
    update_frequency_hours: 24
    retention_days: 365
    
  # AI Generation
  ai_generation:
    enabled: true
    model: "gpt-5"  # ChatGPT-5 only, no fallback
    temperature: 0.7
    max_tokens: 500
    generation_count: 3
    auto_approve: false
    use_fallback: false  # Only use GPT-5
    
  # Similarity Analysis
  similarity_analysis:
    enabled: true
    model: "all-MiniLM-L6-v2"
    threshold: 0.7
    max_similar_creatives: 10
    
  # Performance Analysis
  performance_analysis:
    enabled: true
    analysis_frequency_hours: 168  # Weekly
    min_sample_size: 10
    confidence_threshold: 0.7
    
  # Creative Categories
  categories:
    - "global"
    - "product_specific"
    - "seasonal"
    - "promotional"
    - "educational"
    - "social_proof"
    
  # Performance Metrics Weights
  performance_weights:
    roas: 0.4
    ctr: 0.3
    conversion_rate: 0.3
    
  # A/B Testing
  ab_testing:
    enabled: true
    min_test_duration_days: 7
    statistical_significance_threshold: 0.95
    max_concurrent_tests: 5
    
  # Creative Rotation
  rotation:
    enabled: true
    frequency_days: 7
    rotation_percentage: 0.3
    performance_threshold: 0.6
    
  # Notifications
  notifications:
    enabled: true
    channels: ["slack", "email"]
    events:
      - "high_performing_creative"
      - "creative_fatigue_detected"
      - "ai_creative_generated"
      - "ab_test_completed"
