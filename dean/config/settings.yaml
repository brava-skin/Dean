version: 1.2
env: prod
branding_name: "Dean"

audit:
  last_changed_at: "2025-10-13T00:00:00Z"
  last_changed_by: "you@company.com"
  changelog: |
    - v1.2: Add profiles, richer guardrails, reinvestment policy, data-quality,
            simulation knobs, naming/compliance, and execution controls.
    - v1.2-eur: Switch account timezone to Europe/Amsterdam and adopt EUR.
                Added *_eur keys while keeping *_usd for backward compatibility.
                Updated templates to use €.
    - v1.2-ig: Add explicit Instagram placements and optional instagram_actor_id env

# ── Timezones ─────────────────────────────────────────────────────────────────
account_timezone: "Europe/Amsterdam"
notifications_timezone: "Europe/Amsterdam"
dst_note: "Windows are interpreted in account timezone; notifications in EU/AMS."

ids:
  testing_campaign_id: "120231838265440160"
  testing_adset_id: "120231838265460160"
  validation_campaign_id: "120231838417260160"
  scaling_campaign_id: "120231838441470160"

profiles:
  production:
    dry_run: false
    write_enabled: true
  staging:
    dry_run: true
    write_enabled: false
    notes: "Safe sandbox; relax thresholds; no writes."

mode:
  current: production

meta_defaults:
  objective: "SALES"
  conversion_location: "website"
  pixel_event: "Purchase"
  attribution:
    click_days: 7
    view_days: 1
    roas_source: "computed"
  bid_strategy: "lowest_cost"
  geo:
    country: "US"
  audience:
    type: "broad"
    gender: "male"
    age_min: 18
    age_max: 54
    exclude_purchasers_days: 60
    exclusions:
      engaged_custom_audience_ids: []
      purchaser_custom_audience_ids: []
      lookalike_exclusions: []
  # Legacy placement knobs kept for backward compat with any code still reading these
  placements:
    testing_mode: "advantage_plus"
    validation_mode: "advantage_plus"
    scaling_mode: "advantage_plus"
  creative:
    dynamic_creative: false
    cta: "SHOP_NOW"
    link_url_env: "STORE_URL"
    instagram_actor_id_env: "IG_ACTOR_ID"   # optional: set env to force IG handle
    utm:
      template: "utm_source=meta&utm_medium=paid&utm_campaign={{campaign.name}}&utm_adset={{adset.name}}&utm_content={{ad.name}}"
      require: false
  attribution_windows_override: null

# ── Global placements (used if a stage does not override) ─────────────────────
placements:
  publisher_platforms: ["facebook", "instagram"]
  device_platforms: ["mobile", "desktop"]     # or ["mobile"] to force mobile-only
  facebook_positions: ["feed", "video_feeds", "marketplace"]
  instagram_positions: ["feed", "story", "reels", "explore"]
  messenger_positions: []
  audience_network_positions: []

# ── Testing ───────────────────────────────────────────────────────────────────
testing:
  daily_budget_eur: {{rules.config_refs.testing.daily_budget_eur}}
  daily_budget_usd: {{rules.config_refs.testing.daily_budget_usd}}
  keep_ads_live: {{rules.config_refs.testing.keep_ads_live}}
  max_active_ads: {{rules.config_refs.testing.max_active_ads}}
  optimization_goal: "PURCHASE"
  attribution: "7d_click_1d_view"
  bid_strategy: "lowest_cost"
  dynamic_creative: false
  pause_dead_hours: true
  dead_hours_window: "02:00-06:00"
  minimums:
    min_impressions: {{rules.config_refs.testing.minimums.min_impressions}}
    min_clicks: {{rules.config_refs.testing.minimums.min_clicks}}
    min_spend_eur: {{rules.config_refs.testing.minimums.min_spend_eur}}
    min_spend_usd: {{rules.config_refs.testing.minimums.min_spend_usd}}
  fairness:
    min_spend_before_kill_eur: {{rules.config_refs.testing.fairness.min_spend_before_kill_eur}}
    min_spend_before_kill_usd: {{rules.config_refs.testing.fairness.min_spend_before_kill_usd}}
    min_runtime_hours: {{rules.config_refs.testing.fairness.min_runtime_hours}}
  queue_rotation:
    enable: true
    refill_on_kill: true
    max_launches_per_day: {{rules.config_refs.testing.queue_rotation.max_launches_per_day}}
  naming_prefix: "[TEST]"
  # Stage-specific placements (optional; if omitted, uses global placements)
  placements:
    publisher_platforms: ["facebook", "instagram"]
    device_platforms: ["mobile", "desktop"]
    facebook_positions: ["feed", "video_feeds"]
    instagram_positions: ["feed", "story", "reels"]
    messenger_positions: []
    audience_network_positions: []

# ── Validation ────────────────────────────────────────────────────────────────
validation:
  adset_budget_eur: {{rules.config_refs.validation.adset_budget_eur}}
  adset_budget_usd: {{rules.config_refs.validation.adset_budget_usd}}
  min_days: {{rules.config_refs.validation.min_days}}
  max_days: {{rules.config_refs.validation.max_days}}
  total_spend_cap_eur: {{rules.config_refs.validation.total_spend_cap_eur}}
  total_spend_cap_usd: {{rules.config_refs.validation.total_spend_cap_usd}}
  optimization_goal: "PURCHASE"
  attribution: "7d_click_1d_view"
  bid_strategy: "lowest_cost"
  dynamic_creative: false
  minimums:
    min_impressions: {{rules.config_refs.validation.minimums.min_impressions}}
    min_clicks: {{rules.config_refs.validation.minimums.min_clicks}}
    min_spend_eur: {{rules.config_refs.validation.minimums.min_spend_eur}}
    min_spend_usd: {{rules.config_refs.validation.minimums.min_spend_usd}}
  promotion:
    pause_validation_on_promotion: true
  naming_prefix: "[VALID]"
  placements:
    publisher_platforms: ["facebook", "instagram"]
    device_platforms: ["mobile", "desktop"]
    facebook_positions: ["feed", "video_feeds", "marketplace"]
    instagram_positions: ["feed", "story", "reels", "explore"]
    messenger_positions: []
    audience_network_positions: []

# ── Scaling ───────────────────────────────────────────────────────────────────
scaling:
  adset_start_budget_eur: {{rules.config_refs.scaling.adset_start_budget_eur}}
  adset_start_budget_usd: {{rules.config_refs.scaling.adset_start_budget_usd}}
  allow_cbo: true
  cbo_entry_budget_eur: {{rules.config_refs.scaling.cbo_entry_budget_eur}}
  cbo_entry_budget_usd: {{rules.config_refs.scaling.cbo_entry_budget_usd}}
  cbo_increment_pct: {{rules.config_refs.scaling.cbo_increment_pct}}
  optimization_goal: "PURCHASE"
  attribution: "7d_click_1d_view"
  bid_strategy: "lowest_cost"
  dynamic_creative: true
  budget:
    min_eur: {{rules.config_refs.scaling.budget.min_eur}}
    max_eur: {{rules.config_refs.scaling.budget.max_eur}}
    min_usd: {{rules.config_refs.scaling.budget.min_usd}}
    max_usd: {{rules.config_refs.scaling.budget.max_usd}}
    max_step_pct: {{rules.config_refs.scaling.budget.max_step_pct}}
    cooldown_hours_after_scale: {{rules.config_refs.scaling.budget.cooldown_hours_after_scale}}
  hysteresis:
    roas_down_band: {{rules.config_refs.scaling.hysteresis.roas_down_band}}
    cpa_up_band: {{rules.config_refs.scaling.hysteresis.cpa_up_band}}
  reinvestment:
    enabled: true
    strategy: "proportional_to_roas"
    allocate_pct_of_freed: {{rules.config_refs.scaling.reinvestment.allocate_pct_of_freed}}
    min_increment_eur: {{rules.config_refs.scaling.reinvestment.min_increment_eur}}
    min_increment_usd: {{rules.config_refs.scaling.reinvestment.min_increment_usd}}
  refresh_winner:
    enabled: true
    after_good_days: {{rules.config_refs.scaling.refresh_winner.after_good_days}}
    cpa_max: {{rules.config_refs.scaling.refresh_winner.cpa_max}}
    roas_min: {{rules.config_refs.scaling.refresh_winner.roas_min}}
  naming_prefix: "[SCALE]"
  placements:
    publisher_platforms: ["facebook", "instagram"]
    device_platforms: ["mobile", "desktop"]
    facebook_positions: ["feed", "video_feeds", "marketplace"]
    instagram_positions: ["feed", "story", "reels", "explore"]
    messenger_positions: []
    audience_network_positions: []

# ── Guardrails ────────────────────────────────────────────────────────────────
guardrails:
  account_cpa_pause_factor: {{rules.config_refs.guardrails.account_cpa_pause_factor}}
  account_cpa_window_days: {{rules.config_refs.guardrails.account_cpa_window_days}}
  no_purchases_tripwire_hours: {{rules.config_refs.guardrails.no_purchases_tripwire_hours}}
  global_daily_cap_eur: {{rules.config_refs.guardrails.global_daily_cap_eur}}
  global_daily_cap_usd: {{rules.config_refs.guardrails.global_daily_cap_usd}}
  spend_velocity:
    compare_24h_vs_prev_24h: true
    compare_48h_vs_prev_48h: true
    warn_24h_growth_x: {{rules.config_refs.guardrails.spend_velocity.warn_24h_growth_x}}
    warn_48h_growth_x: {{rules.config_refs.guardrails.spend_velocity.warn_48h_growth_x}}
    freeze_scaling_if_exceeds: true
  scaling_freeze_days_on_worsen: {{rules.config_refs.guardrails.scaling_freeze_days_on_worsen}}
  staging_relax_thresholds: true

overrides:
  manual:
    freeze_all_scaling: false
    halt_testing_topups: false
    read_only_mode: false
  emergency_stop:
    enabled: true
    triggers:
      - type: "api_error_rate"
        threshold_pct: {{rules.config_refs.overrides.emergency_stop.api_error_rate_threshold_pct}}
        window_minutes: {{rules.config_refs.overrides.emergency_stop.api_error_rate_window_minutes}}
      - type: "tracking_flatline"
        hours: {{rules.config_refs.overrides.emergency_stop.tracking_flatline_hours}}

# ── Naming ────────────────────────────────────────────────────────────────────
naming:
  enforce: true
  auto_prefix_if_missing: true
  patterns:
    campaign: ["^\\[(TEST|VALID|SCALE|SCALE-CBO)\\]\\s+Brava\\s+—\\s+(ABO|CBO)\\s+—\\s+US Men$"]
    adset: ["^\\[(TEST|VALID|SCALE)\\]\\s+.+$"]
    ad: ["^\\[(TEST|VALID|SCALE)\\]\\s+.+$"]
  warn_on_mismatch: true

# ── Creative compliance ───────────────────────────────────────────────────────
creative_compliance:
  require_fields: ["primary_text", "headline"]
  max_lengths:
    primary_text: 300
    headline: 60
    description: 150
  forbid_terms: ["cures", "miracle", "guaranteed"]
  auto_truncate: true
  require_utm: false

# ── Queue ─────────────────────────────────────────────────────────────────────
queue:
  schema:
    required_columns:
      - video_id
    optional_columns:
      - creative_id
      - name
      - avatar
      - visual_style
      - script
      - video_url
      - thumbnail_url
      - page_id
      - utm_params
      - cogs_override_eur
      - tags
  dedupe:
    by: ["creative_id", "name"]
  prioritization:
    strategy: "fifo"
    tag_weights: {}
  validation:
    check_media_exists: true
    min_duration_sec: {{rules.config_refs.queue_validation.min_duration_sec}}
    max_duration_sec: {{rules.config_refs.queue_validation.max_duration_sec}}

# ── Notifications ─────────────────────────────────────────────────────────────
notifications:
  slack:
    enabled: true
    channels:
      default_env: "SLACK_WEBHOOK_URL"
      errors_env: "SLACK_WEBHOOK_URL_ERRORS"
    route:
      info: "default"
      warn: "default"
      error: "errors"
    digest:
      enabled: true
      time_local: "08:30"
      include_tables: true
      include_stage_summaries: true
    templates:
      kill: "🛑 [{stage}] Killed {name} — {reason} (CPA {cpa}, ROAS {roas})"
      promote: "🚀 [{from}→{to}] {name} — {reason} (start €{budget}/d)"
      scale: "⬆️ [SCALE] {name} +{pct}% → €{new_budget}"
      duplicate: "🧬 [SCALE] {name} ×{count} (PAUSED)"

# ── Reporting ────────────────────────────────────────────────────────────────
reporting:
  exports:
    daily_digest_jsonl: "dean/data/digests/digest_{date}.jsonl"
  fields_in_digest: ["stage", "action", "entities", "ctr", "cpa", "roas", "reason"]

# ── Economics ────────────────────────────────────────────────────────────────
economics:
  currency: "EUR"
  breakeven_cpa_env: "BREAKEVEN_CPA"
  cogs_env: "COGS_PER_PURCHASE"
  fx:
    enabled: false

# ── Data quality ─────────────────────────────────────────────────────────────
data_quality:
  missing_actions_alert:
    enabled: true
    min_spend_for_alert_eur: {{rules.config_refs.data_quality.missing_actions_min_spend_eur}}
    min_spend_for_alert_usd: {{rules.config_refs.data_quality.missing_actions_min_spend_usd}}
  tracking_drop_alert:
    enabled: true
    drop_pct_vs_7d_avg: {{rules.config_refs.data_quality.tracking_drop_pct_vs_7d_avg}}

# ── Execution ────────────────────────────────────────────────────────────────
execution:
  dry_run_env: "DRY_RUN"
  rate_limits:
    retry_max: 5
    backoff_base_seconds: 0.6
    respect_retry_after: true
  pagination:
    insights_page_limit: 500
    max_pages: 50
  concurrency:
    writes_max_parallel: 3
    reads_max_parallel: 5

# ── Simulation ───────────────────────────────────────────────────────────────
simulate:
  enabled: false
  seed: 42
  date_range:
    since: null
    until: null
  stages: ["testing", "validation", "scaling"]
  use_recorded_insights_path: "dean/data/snapshots/insights/"

# ── Logging / state ──────────────────────────────────────────────────────────
logging:
  to_sqlite: true
  sqlite_path: "dean/data/state.sqlite"
  json_log_enabled: true
  actions_log_path: "dean/data/actions.log.jsonl"

# ── CBO ──────────────────────────────────────────────────────────────────────
cbo:
  enabled: true
  campaign_name: "[SCALE-CBO] Brava — CBO — US Men"
  min_adsets: {{rules.config_refs.cbo.min_adsets}}
  max_adsets: {{rules.config_refs.cbo.max_adsets}}
  min_per_adset_eur: {{rules.config_refs.cbo.min_per_adset_eur}}
  min_per_adset_usd: {{rules.config_refs.cbo.min_per_adset_usd}}
  budget_increment_pct: {{rules.config_refs.cbo.budget_increment_pct}}
  cooldown_hours: {{rules.config_refs.cbo.cooldown_hours}}

# ── Copy bank ────────────────────────────────────────────────────────────────
copy_bank:
  path: "dean/data/copy_bank.json"
  strategy: "round_robin"
