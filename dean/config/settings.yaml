# =====================================================
# DEAN SYSTEM SETTINGS
# Infrastructure, IDs, and System Configuration
# =====================================================

version: 2.0
env: prod
branding_name: "Dean"

# ── Meta Account Configuration ───────────────────────
account:
  timezone: "Europe/Amsterdam"
  currency: "EUR"

# Copy bank configuration
copy_bank:
  path: "data/copy_bank.json"
  strategy: "round_robin"

# Campaign & AdSet IDs (root level for backward compatibility)
ids:
  testing_campaign_id: "120231838265440160"
  testing_adset_id: "120231838265460160"
  validation_campaign_id: "120231838417260160"
  scaling_campaign_id: "120231838441470160"

# ── Meta API Defaults ────────────────────────────────
meta:
  objective: "SALES"
  conversion_location: "website"
  pixel_event: "Purchase"
  bid_strategy: "lowest_cost"
  
  attribution:
    click_days: 7
    view_days: 1
    roas_source: "computed"
  
  geo:
    country: "US"
  
  audience:
    type: "broad"
    gender: "male"
    age_min: 18
    age_max: 54
    exclude_purchasers_days: 60
  
  creative:
    dynamic_creative: false
    cta: "SHOP_NOW"
    link_url_env: "STORE_URL"
    instagram_actor_id_env: "IG_ACTOR_ID"

# ── Placements ───────────────────────────────────────
placements:
  default:
    publisher_platforms: ["facebook", "instagram"]
    device_platforms: ["mobile", "desktop"]
    facebook_positions: ["feed", "video_feeds", "marketplace"]
    instagram_positions: ["feed", "story", "reels", "explore"]
    messenger_positions: []
    audience_network_positions: []
  
  testing:
    publisher_platforms: ["facebook", "instagram"]
    facebook_positions: ["feed", "video_feeds"]
    instagram_positions: ["feed", "story", "reels"]
  
  advantage_plus: true  # Use Advantage+ placement

# ── Stage Configurations ─────────────────────────────
testing:
  daily_budget_eur: 50
  keep_ads_live: 10
  max_active_ads: 10
  target_active_ads: 10                  # NEW: Always maintain 10 creatives
  max_testing_days: 7                    # Extended for Andromeda learning
  optimization_goal: "PURCHASE"
  naming_prefix: "[TEST]"
  
  # Budget allocation for 10 creatives
  budget_per_creative_eur: 5.0          # NEW: €5 per creative (€50 ÷ 10)
  min_budget_per_creative_eur: 2.0      # NEW: Minimum budget per creative
  max_budget_per_creative_eur: 8.0      # NEW: Maximum budget per creative
  
  # Andromeda-specific settings
  creative_rotation_frequency: "weekly"  # NEW: Weekly creative refresh
  andromeda_optimized: true             # NEW: Flag for Andromeda features
  
  queue:
    enable_rotation: true
    refill_on_kill: true
    max_launches_per_day: 10             # Updated for 10-creative system
    maintain_creative_count: 10          # Always keep 10 creatives running
    # Creative selection is now random - no diversity checking needed

validation:
  adset_budget_eur: 40
  min_days: 2
  max_days: 7                              # Updated to align with 7-day validation window
  total_spend_cap_eur: 120
  optimization_goal: "PURCHASE"
  naming_prefix: "[VALID]"
  
  promotion:
    pause_on_promotion: true

scaling:
  adset_start_budget_eur: 100
  allow_cbo: true
  cbo_entry_budget_eur: 400
  cbo_increment_pct: [50, 100]
  optimization_goal: "PURCHASE"
  naming_prefix: "[SCALE]"
  
  budget:
    min_eur: 10
    max_eur: 5000
    max_step_pct: 100
    cooldown_hours: 24
  
  reinvestment:
    enabled: true
    strategy: "proportional_to_roas"
    allocate_pct_of_freed: 50
    min_increment_eur: 10

# ── Queue Management ──────────────────────────────────
queue:
  source: "supabase"  # or "csv"
  table: "meta_creatives"
  
  schema:
    required_columns: ["video_id"]
    optional_columns: ["creative_id", "name", "avatar", "visual_style", "script", "filename"]
  
  validation:
    check_media_exists: true
    min_duration_sec: 5
    max_duration_sec: 120
  
  dedupe_by: ["creative_id", "name"]
  prioritization: "fifo"

# ── Notifications ─────────────────────────────────────
notifications:
  slack:
    enabled: true
    default_webhook_env: "SLACK_WEBHOOK_URL"
    errors_webhook_env: "SLACK_WEBHOOK_URL_ERRORS"
    
    routing:
      info: "default"
      warn: "default"
      error: "errors"
    
    digest:
      enabled: true
      time_local: "08:30"
      timezone: "Europe/Amsterdam"

# ── Data & Logging ────────────────────────────────────
logging:
  # SQLite for local state (required for fast operations)
  sqlite:
    enabled: true
    path: "dean/data/state.sqlite"
  
  # Supabase for ML data (required for ML mode)
  supabase:
    enabled: true
    table_env: "SUPABASE_TABLE"
  
  # Action logs
  actions_log: "dean/data/actions.log.jsonl"
  
  # Daily digests
  digests_dir: "dean/data/digests"

# ── Safety & Compliance ───────────────────────────────
safety:
  guardrails:
    account_cpa_pause_factor: 1.5
    account_cpa_window_days: 2
    no_purchases_tripwire_hours: 48
    global_daily_cap_eur: 3000
  
  spend_velocity:
    warn_24h_growth: 1.5
    warn_48h_growth: 2.5
    freeze_scaling_if_exceeds: true
  
  emergency_stop:
    enabled: true
    api_error_threshold_pct: 40
    tracking_flatline_hours: 24

# ── Compliance ────────────────────────────────────────
compliance:
  naming:
    enforce: true
    auto_prefix_if_missing: true
  
  creative:
    max_primary_text: 300
    max_headline: 60
    max_description: 150
    forbid_terms: ["cures", "miracle", "guaranteed"]
    auto_truncate: true

# ── Execution ─────────────────────────────────────────
execution:
  rate_limits:
    retry_max: 5
    backoff_base_seconds: 0.6
    respect_retry_after: true
  
  pagination:
    insights_page_limit: 500
    max_pages: 50
  
  concurrency:
    writes_max_parallel: 3
    reads_max_parallel: 5

# ── Data Quality ──────────────────────────────────────
data_quality:
  missing_actions_alert:
    enabled: true
    min_spend_for_alert_eur: 20
  
  tracking_drop_alert:
    enabled: true
    drop_pct_vs_7d_avg: 60
