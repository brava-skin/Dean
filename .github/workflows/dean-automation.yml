name: Dean 10-Creative Andromeda System

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch: # Allow manual runs

jobs:
  dean-automation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        echo "üì¶ Installing Python dependencies..."
        echo "üíæ Using cached dependencies when available"
        python -m pip install --upgrade pip
        pip install --cache-dir ~/.cache/pip -r dean/requirements.txt
        echo "‚úÖ Dependencies installed successfully"
        
    - name: Run Dean 10-Creative Andromeda System
      env:
        # Meta Ads API Configuration
        FB_APP_ID: ${{ secrets.FB_APP_ID }}
        FB_APP_SECRET: ${{ secrets.FB_APP_SECRET }}
        FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
        FB_AD_ACCOUNT_ID: ${{ secrets.FB_AD_ACCOUNT_ID }}
        FB_PIXEL_ID: ${{ secrets.FB_PIXEL_ID }}
        FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
        IG_ACTOR_ID: ${{ secrets.IG_ACTOR_ID }}
        
        # Supabase Configuration
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        SUPABASE_TABLE: ${{ secrets.SUPABASE_TABLE }}
        
        # Creative Intelligence System Configuration
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        
        # Business Configuration
        STORE_URL: ${{ secrets.STORE_URL }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        BREAKEVEN_CPA: ${{ secrets.BREAKEVEN_CPA }}
        COGS_PER_PURCHASE: ${{ secrets.COGS_PER_PURCHASE }}
        USD_EUR_RATE: ${{ secrets.USD_EUR_RATE }}
        
        # ML Configuration
        ML_MODE: true
        ML_LEARNING_RATE: 0.01
        ML_CONFIDENCE_THRESHOLD: 0.7
        
        # Rate Limiting Configuration
        META_REQUEST_DELAY: 2.0
        META_MAX_CONCURRENT_INSIGHTS: 1
        META_RETRY_MAX: 5
        META_BACKOFF_BASE: 2.0
        META_BUC_ENABLED: true
        
        # Timezone
        TZ: Europe/Amsterdam
        
      run: |
        echo "üöÄ Starting Dean 10-Creative Andromeda System..."
        echo "üìä Features: 10-creative testing, Andromeda optimization, weekly rotation"
        echo "‚è∞ Running every 30 minutes"
        echo ""
        
        # Change to dean directory where config files are located
        cd dean
        
        # Run Dean with production profile
        python src/main.py --profile production
        
        echo ""
        echo "‚úÖ Dean automation cycle completed"
        echo "üìä Next run in 30 minutes"