name: Dean ASC+ Campaign Automation

on:
  workflow_dispatch: # Manual runs still available
  schedule:
    # Run every 30 minutes for ASC+ campaign monitoring
    - cron: '*/30 * * * *'

jobs:
  dean-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Reduced timeout since we're optimizing
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # Only fetch latest commit, faster checkout
    
    # Install ffmpeg using pre-built binaries (MUCH faster than apt-get)
    - name: Install ffmpeg (optimized - pre-built binaries)
      run: |
        echo "üìπ Installing ffmpeg (optimized method)..."
        # Try pre-built static binary first (fastest - installs in seconds)
        if curl -f -L --max-time 10 https://github.com/eugeneware/ffmpeg-static/releases/download/b6.0.1/ffmpeg-linux-x64 -o /tmp/ffmpeg 2>/dev/null; then
          chmod +x /tmp/ffmpeg
          sudo mv /tmp/ffmpeg /usr/local/bin/ffmpeg
          echo "‚úÖ ffmpeg installed via pre-built binary (fast method)"
        else
          # Fallback: Use apt-get with optimized flags (slower but reliable)
          echo "‚ö†Ô∏è  Pre-built binary unavailable, using apt-get (optimized)..."
          sudo apt-get update -qq -o Acquire::http::Timeout=10
          sudo apt-get install -y --no-install-recommends --no-upgrade ffmpeg
          echo "‚úÖ ffmpeg installed via apt-get"
        fi
        ffmpeg -version | head -1
    
    # Set up Python 3.11 (optimized - v5 with faster caching)
    - name: Set up Python 3.11
      timeout-minutes: 5  # Timeout for Python setup (should be fast, fail if >5min)
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'  # Enable built-in pip caching (faster in v5)
        cache-dependency-path: 'dean/requirements.txt'
        architecture: 'x64'  # Explicitly set architecture for faster setup
        allow-prereleases: false  # Don't use pre-release versions (faster)
        
    # Enhanced pip cache (parallel with setup-python cache)
    - name: Cache pip dependencies (enhanced)
      uses: actions/cache@v4
      id: pip-cache
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python3.11/site-packages
        key: ${{ runner.os }}-python3.11-pip-${{ hashFiles('dean/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-python3.11-pip-
          ${{ runner.os }}-pip-
          
    - name: Install Python dependencies (optimized - batched)
      timeout-minutes: 10  # Timeout for dependency installation
      run: |
        echo "üì¶ Installing Python dependencies (optimized - batched install)..."
        # Use faster pip upgrade with timeout
        python -m pip install --upgrade pip setuptools wheel --quiet --no-cache-dir --timeout 30 || python -m pip install --upgrade pip setuptools wheel --quiet --no-cache-dir
        
        # Batch 1: Core dependencies (lightweight, fast)
        echo "  ‚Üí Installing core dependencies..."
        pip install --cache-dir ~/.cache/pip --quiet --no-warn-script-location --timeout 60 \
          facebook-business==19.0.1 python-dotenv==1.0.1 PyYAML==6.0.2 requests==2.32.3 \
          pytz pandas==2.2.2 openpyxl==3.1.5 SQLAlchemy==2.0.35 supabase schedule \
          jsonschema prometheus-client || echo "‚ö†Ô∏è  Some core dependencies failed (non-critical)"
        
        # Batch 2: Essential ML (sequential for reliability)
        echo "  ‚Üí Installing essential ML libraries..."
        pip install --cache-dir ~/.cache/pip --quiet --no-warn-script-location --timeout 120 \
          xgboost scikit-learn numpy scipy joblib lightgbm catboost statsmodels psycopg2-binary || echo "‚ö†Ô∏è  Some ML dependencies failed (non-critical)"
        
        # Batch 3: Visualization & Time Series
        echo "  ‚Üí Installing visualization & time-series libraries..."
        pip install --cache-dir ~/.cache/pip --quiet --no-warn-script-location --timeout 120 \
          plotly seaborn matplotlib tslearn prophet arch || echo "‚ö†Ô∏è  Some visualization dependencies failed (non-critical)"
        
        # Batch 4: NLP & Image Processing (skip spacy model download for speed)
        echo "  ‚Üí Installing NLP & image processing libraries..."
        pip install --cache-dir ~/.cache/pip --quiet --no-warn-script-location --timeout 180 \
          sentence-transformers transformers spacy nltk Pillow opencv-python \
          textblob vaderSentiment openai || echo "‚ö†Ô∏è  Some NLP dependencies failed (non-critical)"
        # Skip spacy model download (can be done later if needed)
        python -m spacy download en_core_web_sm --quiet || echo "‚ö†Ô∏è  Spacy model download skipped (optional)"
        
        # Batch 5: Optional lightweight dependencies (skip if fails)
        echo "  ‚Üí Installing optional dependencies..."
        pip install --cache-dir ~/.cache/pip --quiet --no-warn-script-location --timeout 60 \
          faiss-cpu dask optuna redis psutil alembic ffmpeg-python || echo "‚ö†Ô∏è  Optional dependencies skipped (non-critical)"
        
        # Skip heavy optional dependencies that aren't critical for runtime
        # These can be installed later if needed: mlflow wandb tensorboard torch shap featuretools
        
        echo "‚úÖ All dependencies installed successfully"
        
    - name: Verify ffmpeg installation
      run: |
        ffmpeg -version | head -1
        echo "‚úÖ ffmpeg ready"
    
    - name: Run Dean
      env:
        # Meta Ads API Configuration
        FB_APP_ID: ${{ secrets.FB_APP_ID }}
        FB_APP_SECRET: ${{ secrets.FB_APP_SECRET }}
        FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
        FB_AD_ACCOUNT_ID: ${{ secrets.FB_AD_ACCOUNT_ID }}
        FB_PIXEL_ID: ${{ secrets.FB_PIXEL_ID }}
        FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
        IG_ACTOR_ID: ${{ secrets.IG_ACTOR_ID }}
        
        # Supabase Configuration
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        SUPABASE_TABLE: ${{ secrets.SUPABASE_TABLE }}
        CREATIVE_STORAGE_BUCKET: creatives
        
        # Creative Generation Configuration
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        FLUX_API_KEY: ${{ secrets.FLUX_API_KEY }}
        
        # Business Configuration
        STORE_URL: ${{ secrets.STORE_URL }}
        SHOPIFY_STORE_URL: ${{ secrets.STORE_URL }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        BREAKEVEN_CPA: ${{ secrets.BREAKEVEN_CPA }}
        COGS_PER_PURCHASE: ${{ secrets.COGS_PER_PURCHASE }}
        USD_EUR_RATE: ${{ secrets.USD_EUR_RATE }}
        
        # ML Configuration
        ML_MODE: true
        ML_LEARNING_RATE: 0.01
        ML_CONFIDENCE_THRESHOLD: 0.7
        
        # Rate Limiting Configuration
        META_REQUEST_DELAY: 2.0
        META_MAX_CONCURRENT_INSIGHTS: 1
        META_RETRY_MAX: 5
        META_BACKOFF_BASE: 2.0
        META_BUC_ENABLED: true
        
        # Timezone
        TZ: Europe/Amsterdam
        
      run: |
        echo "üöÄ Starting Dean ASC+ Campaign Automation..."
        echo ""
        echo "üìã Campaign Configuration:"
        echo "   - Campaign Type: Advantage+ Shopping Campaign (ASC+)"
        echo "   - Budget: ‚Ç¨50/day base (‚Ç¨5 per creative, scales up when ready)"
        echo "   - Target: 10 active creatives (Andromeda requirement)"
        echo "   - Audience: Men aged 18-54 in United States"
        echo "   - Creative Type: Static images with text overlays"
        echo ""
        
        # Change to dean directory where config files are located
        cd dean
        
        # Verify config files exist
        echo "üìÅ Checking configuration files..."
        ls -la config/ || echo "‚ö†Ô∏è  Config directory not found"
        cat config/settings.yaml | grep -A 5 "asc_plus:" || echo "‚ö†Ô∏è  ASC+ section not found in settings.yaml"
        
        # Set Python optimizations for faster execution
        export PYTHONUNBUFFERED=1
        export PYTHONDONTWRITEBYTECODE=1  # Skip .pyc files
        export PYTHONOPTIMIZE=1  # Remove assert statements and debug code
        
        # Run Dean ASC+ automation with optimizations
        python -u -O src/main.py  # -O flag enables optimizations
        
        echo ""
        echo "‚úÖ Dean ASC+ automation cycle completed"
        echo "üìä Next run scheduled in 30 minutes"
        echo "üé® Creative generation: Flux API + ChatGPT-5 + ffmpeg"