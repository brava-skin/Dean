name: Dean ASC+ Campaign Automation

on:
  workflow_dispatch: # Manual runs still available
  schedule:
    # Run every hour for ASC+ campaign monitoring
    - cron: '0 * * * *'

jobs:
  dean-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Reduced timeout since we're optimizing
    env:
      AUTOMATION_PAUSED: "false"
    
    steps:
    - name: Automation paused notice
      if: ${{ env.AUTOMATION_PAUSED == 'true' }}
      run: |
        echo "üö´ Dean ASC+ automation is currently paused via GitHub Actions workflow."
        echo "   - Set AUTOMATION_PAUSED to \"false\" in .github/workflows/dean-automation.yml to resume."
        echo "   - Last checked: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
      shell: bash

    - name: Checkout repository
      if: ${{ env.AUTOMATION_PAUSED != 'true' }}
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # Only fetch latest commit, faster checkout
    
    # Install ffmpeg using pre-built binaries (MUCH faster than apt-get)
    - name: Install ffmpeg (optimized - pre-built binaries)
      if: ${{ env.AUTOMATION_PAUSED != 'true' }}
      run: |
        echo "üìπ Installing ffmpeg (optimized method)..."
        # Try pre-built static binary first (fastest - installs in seconds)
        if curl -f -L --max-time 10 https://github.com/eugeneware/ffmpeg-static/releases/download/b6.0.1/ffmpeg-linux-x64 -o /tmp/ffmpeg 2>/dev/null; then
          chmod +x /tmp/ffmpeg
          sudo mv /tmp/ffmpeg /usr/local/bin/ffmpeg
          echo "‚úÖ ffmpeg installed via pre-built binary (fast method)"
        else
          # Fallback: Use apt-get with optimized flags (slower but reliable)
          echo "‚ö†Ô∏è  Pre-built binary unavailable, using apt-get (optimized)..."
          sudo apt-get update -qq -o Acquire::http::Timeout=10
          sudo apt-get install -y --no-install-recommends --no-upgrade ffmpeg
          echo "‚úÖ ffmpeg installed via apt-get"
        fi
        ffmpeg -version | head -1
    
    # Set up Python 3.11 (optimized - v5 with faster caching)
    - name: Set up Python 3.11
      if: ${{ env.AUTOMATION_PAUSED != 'true' }}
      timeout-minutes: 5  # Timeout for Python setup (should be fast, fail if >5min)
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'  # Enable built-in pip caching (faster in v5)
        cache-dependency-path: 'dean/requirements.txt'
        architecture: 'x64'  # Explicitly set architecture for faster setup
        allow-prereleases: false  # Don't use pre-release versions (faster)
        
    # Enhanced pip cache (parallel with setup-python cache)
    - name: Cache pip dependencies (enhanced)
      if: ${{ env.AUTOMATION_PAUSED != 'true' }}
      uses: actions/cache@v4
      id: pip-cache
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python3.11/site-packages
        key: ${{ runner.os }}-python3.11-pip-${{ hashFiles('dean/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-python3.11-pip-
          ${{ runner.os }}-pip-
          
    - name: Install Python dependencies
      if: ${{ env.AUTOMATION_PAUSED != 'true' }}
      timeout-minutes: 8  # Faster timeout since we removed unused optional dependencies (sentence-transformers, psutil, Pillow)
      run: |
        echo "üì¶ Installing Python dependencies..."
        # Use faster pip upgrade with timeout
        python -m pip install --upgrade pip setuptools wheel --quiet --no-cache-dir --timeout 30 || python -m pip install --upgrade pip setuptools wheel --quiet --no-cache-dir
        
        # Install from requirements.txt (much simpler now)
        echo "  ‚Üí Installing from requirements.txt..."
        pip install --cache-dir ~/.cache/pip --quiet --no-warn-script-location --timeout 120 \
          -r dean/requirements.txt || echo "‚ö†Ô∏è  Some dependencies failed (non-critical)"
        
        echo "‚úÖ All dependencies installed successfully"
        
    - name: Verify ffmpeg installation
      if: ${{ env.AUTOMATION_PAUSED != 'true' }}
      run: |
        ffmpeg -version | head -1
        echo "‚úÖ ffmpeg ready"
    
    - name: Run Dean
      if: ${{ env.AUTOMATION_PAUSED != 'true' }}
      env:
        # Meta Ads API Configuration
        FB_APP_ID: ${{ secrets.FB_APP_ID }}
        FB_APP_SECRET: ${{ secrets.FB_APP_SECRET }}
        FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
        FB_AD_ACCOUNT_ID: ${{ secrets.FB_AD_ACCOUNT_ID }}
        FB_PIXEL_ID: ${{ secrets.FB_PIXEL_ID }}
        FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
        IG_ACTOR_ID: ${{ secrets.IG_ACTOR_ID }}
        
        # Supabase Configuration
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        SUPABASE_TABLE: ${{ secrets.SUPABASE_TABLE }}
        CREATIVE_STORAGE_BUCKET: creatives
        
        # Creative Generation Configuration
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        FLUX_API_KEY: ${{ secrets.FLUX_API_KEY }}
        
        # Business Configuration
        STORE_URL: ${{ secrets.STORE_URL }}
        SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE_URL }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        BREAKEVEN_CPA: ${{ secrets.BREAKEVEN_CPA }}
        COGS_PER_PURCHASE: ${{ secrets.COGS_PER_PURCHASE }}
        
        # Rate Limiting Configuration
        META_REQUEST_DELAY: 2.0
        META_MAX_CONCURRENT_INSIGHTS: 1
        META_RETRY_MAX: 5
        META_BACKOFF_BASE: 2.0
        META_BUC_ENABLED: true
        
        # Timezone
        TZ: Europe/Amsterdam
        
      run: |
        echo "üöÄ Starting Dean ASC+ Campaign Automation..."
        echo ""
        echo "üìã Campaign Configuration:"
        echo "   - Campaign Type: Advantage+ Shopping Campaign (ASC+)"
        echo "   - Budget: ‚Ç¨100/day fixed (30-day ATC learning phase, no scaling)"
        echo "   - Optimization: Add to Cart (ATC) - teaching pixel buyer intent patterns"
        echo "   - Target: 10 active creatives"
        echo "   - Audience: Men aged 18-54 in United States (broad targeting)"
        echo "   - Creative Type: Static images with text overlays"
        echo ""
        
        # Change to dean directory where config files are located
        cd dean
        
        # Verify config files exist
        echo "üìÅ Checking configuration files..."
        ls -la config/ || echo "‚ö†Ô∏è  Config directory not found"
        cat config/settings.yaml | grep -A 5 "asc_plus:" || echo "‚ö†Ô∏è  ASC+ section not found in settings.yaml"
        
        # Set Python optimizations for faster execution
        export PYTHONUNBUFFERED=1
        export PYTHONDONTWRITEBYTECODE=1  # Skip .pyc files
        export PYTHONOPTIMIZE=1  # Remove assert statements and debug code
        
        # Run Dean ASC+ automation with optimizations
        python -u -O src/main.py  # -O flag enables optimizations
        
        echo ""
        echo "‚úÖ Dean ASC+ automation cycle completed"
        echo "üìä Next run scheduled in 1 hour"
        echo "üé® Creative generation: Flux API + ChatGPT-5 + ffmpeg"