name: Dean ASC+ Campaign Automation

on:
  schedule:
    # Run every 30 minutes for ASC+ campaign monitoring
    - cron: '*/30 * * * *'
  workflow_dispatch: # Allow manual runs

jobs:
  dean-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Prevent hanging workflows
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # Only fetch latest commit, faster checkout
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'  # Enable built-in pip caching
        cache-dependency-path: 'dean/requirements.txt'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('dean/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        echo "üì¶ Installing Python dependencies..."
        echo "üíæ Using cached dependencies when available"
        python -m pip install --upgrade pip --quiet
        pip install --cache-dir ~/.cache/pip --quiet -r dean/requirements.txt
        echo "‚úÖ Dependencies installed successfully"
        
    - name: Cache apt packages
      uses: actions/cache@v3
      with:
        path: /var/cache/apt
        key: ${{ runner.os }}-apt-ffmpeg
        restore-keys: |
          ${{ runner.os }}-apt-
    
    - name: Install ffmpeg
      run: |
        echo "üìπ Installing ffmpeg for text overlay generation..."
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends --no-upgrade ffmpeg
        ffmpeg -version | head -1
        echo "‚úÖ ffmpeg ready"
        
    - name: Run Dean
      env:
        # Meta Ads API Configuration
        FB_APP_ID: ${{ secrets.FB_APP_ID }}
        FB_APP_SECRET: ${{ secrets.FB_APP_SECRET }}
        FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
        FB_AD_ACCOUNT_ID: ${{ secrets.FB_AD_ACCOUNT_ID }}
        FB_PIXEL_ID: ${{ secrets.FB_PIXEL_ID }}
        FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
        IG_ACTOR_ID: ${{ secrets.IG_ACTOR_ID }}
        
        # Supabase Configuration
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        SUPABASE_TABLE: ${{ secrets.SUPABASE_TABLE }}
        CREATIVE_STORAGE_BUCKET: creatives
        
        # Creative Generation Configuration
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        FLUX_API_KEY: ${{ secrets.FLUX_API_KEY }}
        
        # Business Configuration
        STORE_URL: ${{ secrets.STORE_URL }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        BREAKEVEN_CPA: ${{ secrets.BREAKEVEN_CPA }}
        COGS_PER_PURCHASE: ${{ secrets.COGS_PER_PURCHASE }}
        USD_EUR_RATE: ${{ secrets.USD_EUR_RATE }}
        
        # ML Configuration
        ML_MODE: true
        ML_LEARNING_RATE: 0.01
        ML_CONFIDENCE_THRESHOLD: 0.7
        
        # Rate Limiting Configuration
        META_REQUEST_DELAY: 2.0
        META_MAX_CONCURRENT_INSIGHTS: 1
        META_RETRY_MAX: 5
        META_BACKOFF_BASE: 2.0
        META_BUC_ENABLED: true
        
        # Timezone
        TZ: Europe/Amsterdam
        
      run: |
        echo "üöÄ Starting Dean ASC+ Campaign Automation..."
        echo ""
        echo "üìã Campaign Configuration:"
        echo "   - Campaign Type: Advantage+ Shopping Campaign (ASC+)"
        echo "   - Budget: ‚Ç¨50/day"
        echo "   - Target: Men aged 18-54 in United States"
        echo "   - Creative Type: Static images with text overlays"
        echo ""
        
        # Change to dean directory where config files are located
        cd dean
        
        # Verify config files exist
        echo "üìÅ Checking configuration files..."
        ls -la config/ || echo "‚ö†Ô∏è  Config directory not found"
        cat config/settings.yaml | grep -A 5 "asc_plus:" || echo "‚ö†Ô∏è  ASC+ section not found in settings.yaml"
        
        # Set Python optimizations for faster execution
        export PYTHONUNBUFFERED=1
        export PYTHONDONTWRITEBYTECODE=1  # Skip .pyc files
        
        # Run Dean ASC+ automation
        python -u src/main.py
        
        echo ""
        echo "‚úÖ Dean ASC+ automation cycle completed"
        echo "üìä Next run scheduled in 30 minutes"
        echo "üé® Creative generation: Flux API + ChatGPT-5 + ffmpeg"